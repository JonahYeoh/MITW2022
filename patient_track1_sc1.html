<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>#1 SC1</title>
    <style>
        #main {
            width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .field {
            width: 150pt;
            color: blue;
            background-color: pink;
            display: inline-block;
            padding-left: 20px;
        }

        table,
        table tr,
        table tr td {
            border: 1px black solid;
            border-collapse: collapse;
        }

        td {
            padding: 5px;
        }

        input[type=text],
        input[type=number],
        select {
            width: 300px;
        }
    </style>
    <script src="setting.js"></script>
    <script>
        function HTTPGetData(urlStr, callback_fn) {
            var rawFile = new XMLHttpRequest();
            rawFile.open("GET", urlStr, true);
            rawFile.setRequestHeader("Content-type", "application/json+fhir");
            rawFile.onreadystatechange = function () {
                if (rawFile.readyState === 4) {
                    ret = rawFile.responseText;
                    alert("data retrieved");
                    var output_panel = document.getElementById("output_panel");
                    output_panel.value = ret;
                    callback_fn(JSON.parse(ret));
                }
            }
            rawFile.send();
        }

        function HTTPDeleteData(urlStr) {
            var rawFile = new XMLHttpRequest();
            rawFile.open("Delete", urlStr, true);
            rawFile.setRequestHeader("Content-type", "application/json+fhir");
            rawFile.onreadystatechange = function () {
                if (rawFile.readyState === 4) {
                    ret = rawFile.responseText;
                    alert('data retrieved');
                    var output_panel = document.getElementById("output_panel");
                    output_panel.value = ret;
                }
            }
            rawFile.send();
        }

        function HTTPPutData(urlStr, dataStr) {
            var rawFile = new XMLHttpRequest();
            rawFile.open("Put", urlStr, true);
            rawFile.setRequestHeader("Content-type", "application/json+fhir");
            rawFile.onreadystatechange = function () {
                if (rawFile.readyState === 4) {
                    ret = rawFile.responseText;
                    alert('data retrieved');
                    var output_panel = document.getElementById("output_panel");
                    output_panel.value = ret;
                }
            }
            rawFile.send(dataStr);
        }

        function showPatient(json_obj) {
            if (json_obj['entry'] == undefined){
                console.log("not found");
                document.getElementById("patient_id").value = "";
                document.getElementById("name_prefix").value = "Mr.";
                document.getElementById("fname").value = "";
                document.getElementById("lname").value = "";
                document.getElementById("gender").value = "male";
                document.getElementById("birthDate").value = "";
                document.getElementById("organization").value = "MITW.ForIdentifier";
            }
            else if (json_obj['total'] == 1) {
                var patient = json_obj['entry'][0]['resource'];
                document.getElementById("patient_id").value = patient['id'];
                document.getElementById("name_prefix").value = patient['name'][0]['prefix'][0];
                document.getElementById("fname").value = patient['name'][0]['text'].split(" ")[1];
                document.getElementById("lname").value = patient['name'][0]['text'].split(" ")[0];
                document.getElementById("national_id").value = "";
                document.getElementById("arc_id").value = "";
                document.getElementById("passport_id").value = "";
                document.getElementById("mr_id").value = "";
                for (let i = 0; i < patient['identifier'].length; i++) {
                    identifier_i = patient['identifier'][i];
                    if (identifier_i['system'] == "http://www.moi.gov.tw/") {
                        document.getElementById("national_id").value = identifier_i['value'];
                    }
                    else if (identifier_i['system'] == "http://www.immigration.gov.tw/") {
                        document.getElementById("arc_id").value = identifier_i['value'];
                    }
                    else if (identifier_i['system'] == "http://www.boca.gov.tw/") {
                        document.getElementById("passport_id").value = identifier_i['value'];
                    }
                    else if (identifier_i['system'] == "https://www.tph.mohw.gov.tw/") {
                        document.getElementById("mr_id").value = identifier_i['value'];
                    }
                }
                document.getElementById("gender").value = patient['gender'];
                document.getElementById("birthDate").value = patient['birthDate'];
                document.getElementById("organization").value = patient['managingOrganization']['reference'].split("/")[1];
            }
            else
            {
                console.log("Retrieve N records");
            }
        }

        function getPatient() {
            const urlStr = `${URL}/Patient`;
            var id = document.getElementById("param_patient_id").value;
            let query_string = '?'
            if (id != '') {
                query_string += `_id=${id}`;
            }
            var nat_id = document.getElementById("param_national_id").value;
            if (nat_id != '') {
                if (query_string.length > 1) {
                    query_string += "&";
                }
                query_string += `identifier=http://www.moi.gov.tw/|${nat_id}`;
            }
            var passport_id = document.getElementById("param_passport_id").value;
            if (passport_id != '') {
                if (query_string.length > 1) {
                    query_string += "&";
                }
                query_string += `identifier=http://www.boca.gov.tw/|${passport_id}`;
            }
            var mr_id = document.getElementById("param_mr_id").value;
            if (mr_id != '') {
                if (query_string.length > 1) {
                    query_string += "&";
                }
                query_string += `identifier=https://www.tph.mohw.gov.tw/|${mr_id}`;
            }
            var arc_id = document.getElementById("param_arc_id").value;
            if (arc_id != '') {
                if (query_string.length > 1) {
                    query_string += "&";
                }
                query_string += `identifier=http://www.immigration.gov.tw/|${arc_id}`;
            }
            var name = document.getElementById("param_name").value;
            if (name != ''){
                if (query_string.length > 1) {
                    query_string += "&";
                }
                query_string += `name=${name}`;
            }
            var org = document.getElementById("param_organization").value;
            if (org != '') {
                if (query_string.length > 1) {
                    query_string += "&";
                }
                query_string += `organization=${org}`;
            }
            const url = urlStr + query_string;
            console.log(url);
            document.getElementById("url_panel").value = url;
            HTTPGetData(url, showPatient);
        }

        function putPatient() {
            const urlStr = `${URL}/Patient/${document.getElementById("patient_id").value}`;
            var resource = {
                "resourceType": "Patient",
                "id": document.getElementById("patient_id").value,
                "identifier": [],
                "active": true,
                "name": [],
                "gender": "",
                "birthDate": "",
                "managingOrganization": {
                    "reference": "Organization/" + document.getElementById("organization").value
                }
            };
            if (document.getElementById("lname").value != '' && document.getElementById("fname").value != '') {
                var name =
                {
                    "use": "official",
                    "prefix": document.getElementById("name_prefix").value,
                    "text": document.getElementById("lname").value + ' ' + document.getElementById("fname").value,
                    "family": document.getElementById("lname").value,
                    "given": [
                        document.getElementById("fname").value
                    ]
                };
                resource['name'] = [name];
            }
            resource['birthDate'] = document.getElementById("birthDate").value;
            resource['gender'] = document.getElementById("gender").options[
                document.getElementById("gender").selectedIndex
            ].value;
            var nat_id = document.getElementById("national_id").value;
            var arc_id = document.getElementById("arc_id").value;
            var ppn_id = document.getElementById("passport_id").value;
            var mr_id = document.getElementById("mr_id").value;
            if (nat_id != '') {
                resource['identifier'].push(
                    {
                        "use": "official",
                        "type": {
                            "coding": [
                                {
                                    "system": "http://terminology.hl7.org/CodeSystem/v2-0203",
                                    "code": "NI"
                                }
                            ]
                        },
                        "system": "http://www.moi.gov.tw/",
                        "value": nat_id
                    }
                )
            }
            if (arc_id != '') {
                resource['identifier'].push(
                    {
                        "use": "official",
                        "type": {
                            "coding": [
                                {
                                    "system": "http://terminology.hl7.org/CodeSystem/v2-0203",
                                    "code": "PRC"
                                }
                            ]
                        },
                        "system": "http://www.immigration.gov.tw/",
                        "value": arc_id
                    }
                )
            }
            if (ppn_id != '') {
                resource['identifier'].push(
                    {
                        "use": "official",
                        "type": {
                            "coding": [
                                {
                                    "system": "http://terminology.hl7.org/CodeSystem/v2-0203",
                                    "code": "PPN"
                                }
                            ]
                        },
                        "system": "http://www.boca.gov.tw/",
                        "value": ppn_id
                    }
                )
            }
            if (mr_id != '') {
                resource['identifier'].push(
                    {
                        "use": "official",
                        "type": {
                            "coding": [
                                {
                                    "system": "http://terminology.hl7.org/CodeSystem/v2-0203",
                                    "code": "MR"
                                }
                            ]
                        },
                        "system": "https://www.tph.mohw.gov.tw/",
                        "value": mr_id
                    }
                )
            };
            console.log(resource);
            console.log(urlStr);
            HTTPPutData(urlStr, JSON.stringify(resource));
        }

        function deletePatient(){
            const urlStr = `${URL}/Patient`;
            var id = document.getElementById("patient_id").value;
            let query_string = '?'
            if (id != '') {
                query_string += `_id=${id}`;
            }
            HTTPDeleteData(urlStr + query_string);
        }
    </script>
</head>

<body>
    <div id="main">
        <div id="parameters">
            <h1>Search</h1>
            <span class="field">Patient ID:</span> <input type="text" id="param_patient_id" />
            <br />
            <span class="field">National ID: </span>
            <input type="text" id="param_national_id" />
            <br />
            <span class="field">ARC ID: </span>
            <input type="text" id="param_arc_id" />
            <br />
            <span class="field">Passport ID: </span>
            <input type="text" id="param_passport_id" />
            <br />
            <span class="field">Medical Record ID: </span>
            <input type="text" id="param_mr_id" />
            <br />
            <span class="field">Name: </span>
            <input type="text" id="param_name" />
            <br />
            <span class="field">Organization: </span>
            <input type="text" id="param_organization" value="MITW.ForIdentifier" disabled/>
            <br />
            <input type="button" onclick="getPatient()" value="SEARCH" />
            <br />
            <textarea id="url_panel" style="height:100px;width:500px;" disabled></textarea>
        </div>
        <hr />
        <div>
            <div id="create">
                <h1>Update</h1>
                <span class="field">Patient ID:</span> <input type="text" id="patient_id" />
                <br />
                <span class="field">Prefix: </span>
                <select id="name_prefix">
                    <option>Mr.</option>
                    <option>Ms.</option>
                    <option>Miss</option>
                    <option>Dr.</option>
                    <option>Prof.</option>
                </select>
                <br />
                <span class="field">First Name: </span>
                <input type="text" id="fname" placeholder="given name" />
                <br />
                <span class="field">Last Name: </span>
                <input type="text" id="lname" placeholder="family name" />
                <br />
                <span class="field">National ID: </span>
                <input type="text" id="national_id" />
                <br />
                <span class="field">ARC ID: </span>
                <input type="text" id="arc_id" />
                <br />
                <span class="field">Passport ID: </span>
                <input type="text" id="passport_id" />
                <br />
                <span class="field">Medical Record ID: </span>
                <input type="text" id="mr_id" />
                <br />
                <span class="field">Gender: </span>
                <select id="gender">
                    <option id="male" value="male">Male</option>
                    <option id="female" value="female">Female</option>
                    <option id="other" value="other">Other</option>
                    <option id="unknown" value="unknown">Unknown</option>
                </select>
                <br />
                <span class="field">Date of Birth: </span>
                <input type="date" id="birthDate" />
                <br />
                <span class="field">Organization: </span>
                <input type="text" id="organization" value="MITW.ForIdentifier" disabled />
                <br />
                <input type="button" onclick="putPatient()" value="UPDATE" />
                <input type="button" onclick="deletePatient()" value="DELETE" />
            </div>
            <hr />
            <div>
                <h1>Output Panel</h1>
                <textarea id="output_panel" disabled style="height:500px;width:600px;"></textarea>
            </div>
        </div>
    </div>
</body>

</html>
